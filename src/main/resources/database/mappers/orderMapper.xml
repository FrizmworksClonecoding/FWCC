<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
 <mapper namespace="com.fw.s1.order.OrderMapper">
 	<resultMap type="OrderlistVO" id="orderAndMileage">
 		<id column="orderNum" property="orderNum"/>
 		<result column="totPrice" property="totPrice"/>
 		<result column="spPrice" property="spPrice"/>
 		<result column="cuNum" property="cuNum"/>
 		<result column="username" property="username"/>
 		<result column="destination" property="destination"/>
 		<result column="orderDate" property="orderDate"/>
		<result column="orderState" property="orderState"/>
		<result column="orderMessage" property="orderMessage"/>
		<result column="orderName" property="orderName"/>
		<association property="mileageVO" javaType="MileageVO">
			<id column="mileNum" property="mileNum"/>
			<result column="usedMile" property="usedMile"/>
			<result column="changeMile" property="changeMile"/>
			<result column="username" property="username"/>
			<result column="orderNum" property="orderNum"/>
			<result column="mileContents" property="mileContents"/>
			<result column="enabledMile" property="enabledMile"/>
		</association>
 	</resultMap>
 
 	<insert id="setOrder" parameterType="OrderlistVO">
 		insert into orderlist(orderNum, totPrice, spPrice, cuNum, username, destination, orderDate, orderState, orderMessage, orderName)
 		values(#{orderNum}, #{totPrice}, #{spPrice}, <if test="cuNum==0">null</if><if test="cuNum!=0">#{cuNum}</if>, 
 		#{username}, #{destination}, sysdate(), 1, #{orderMessage}, #{orderName})
 	</insert>
	<select id="getOrder" parameterType="OrderlistVO" resultMap="orderAndMileage">
		select * from orderlist o inner join mileage m on o.orderNum = m.orderNum
		where o.username=#{username} and m.mileNum = (select max(mileNum) from mileage where orderNum=#{orderNum})
	</select>
	
	<!-- member -->
	<select id="getOrderList" parameterType="OrderlistVO" resultMap="getOrderProduct">
		select O.*, P.productTitle, PF.fileName from orderlist O
		inner join purchase
		on O.orderNum = purchase.orderNum
		inner join product P
		on purchase.productNum = P.productNum
		inner join productFiles PF
		on P.productNum = PF.productNum
		where O.username=#{username} and PF.fileName like 'T_%'
	</select>
	<resultMap type="OrderlistVO" id="getOrderProduct">
		<id column="orderNum" property="orderNum"/>
		<result column="totPrice" property="totPrice"/>
		<result column="spPrice" property="spPrice"/>
		<result column="cuNum" property="cuNum"/>
		<result column="username" property="username"/>
		<result column="destination" property="destination"/>
		<result column="orderDate" property="orderDate"/>
		<result column="orderState" property="orderState"/>
		<result column="orderMessage" property="orderMessage"/>
		<result column="orderName" property="orderName"/>
		<!-- <collection property="products" javaType="java.util.List" ofType="ProductVO">
			<id column="productNum" property="productNum"/>
			<result column="productTitle" property="productTitle"/>
		</collection>
		<collection property="files" javaType="java.util.List" ofType="ProductFileVO">
			<id column="productNum" property="productNum"/>
			<result column="fileName" property="fileName"/>
		</collection> -->
		<association property="productVO">
			<id column="productNum" property="productNum"/>
			<result column="productTitle" property="productTitle"/>
		</association> 
		<association property="productFileVO">
			<id column="productNum" property="productNum"/>
			<result column="fileName" property="fileName"/>
		</association>
	</resultMap>
 </mapper>