<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="com.fw.s1.mileage.MileageMapper">
	<select id="getRecentMileage" parameterType="MileageVO" resultType="MileageVO">
		select * from mileage where mileNum = (select Max(mileNum) from mileage where username = #{username})
	</select>
	<insert id="setMileAfterOrder" parameterType="java.util.List">
		insert into mileage (usedMile, changeMile, username, orderNum, mileContents, enabledMile)
		values
		<foreach collection="list" item="item" separator=",">
			(#{item.usedMile}, #{item.changeMile}, #{item.username}, #{item.orderNum},
			#{item.mileContents}, #{item.enabledMile})
		</foreach>
	</insert>
	<insert id="mileageForAll" parameterType="MileageVO">
		INSERT INTO mileage (usedMile, changeMile, username, orderNum, mileContents, enabledmile)
  		SELECT usedMile, changeMile+#{changeMile}, username, NULL, #{mileContents}, enabledMile+#{enabledMile} 
  		FROM mileage WHERE mileNum IN (SELECT MAX(mileNum) FROM mileage GROUP BY username);
	</insert>
	<insert id="mileageForSelect" parameterType="java.util.List">
		<foreach collection="list" item="item" separator=";">
			insert into mileage (usedMile, changeMile, username, orderNum, mileContents, enabledmile)
			(select usedMile, #{item.changeMile}, username, null, #{item.mileContents}, enabledMile+#{item.enabledMile}
			from mileage where mileNum = (select max(mileNum) from mileage where username=#{item.username}))
		</foreach>
	</insert>
</mapper>